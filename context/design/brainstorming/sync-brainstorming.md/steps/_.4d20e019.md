---
timestamp: 'Tue Nov 25 2025 19:25:42 GMT-0500 (Eastern Standard Time)'
parent: '[[..\20251125_192542.e5baf9ac.md]]'
content_id: 4d20e0199d79f5eb9ba7f4dce3d498c150549b47f253e908e1e43a9e1aa097a9
---

# UserAuthentication

**concept**: UserAuthentication\
**purpose**: To authenticate users so that each person's data is securely associated with their identity and protected from unauthorized access.\
**principle**: If a user registers with a username and password, then later logs in using those same credentials, the system recognizes them as the same user, enabling access to their data. If they log out, their session ends and their private data becomes inaccessible until they log in again.

**state**:

* a set of Users with
  * a username String
  * a hashedPassword String
  * an email String
  * a createdAt Date
* a set of Sessions with
  * a user User
  * a refreshToken String
  * a createdAt Date
  * an expiresAt Date

**actions**:

* `register (username: String, password: String, email: String): (user: User, accessToken: String, refreshToken: String)`
  * **requires**: The provided email and username must not already exist. The email must be in valid format.
  * **effects**: Creates a new user record with a hashed password (email is normalized to lowercase) and returns a new pair of session tokens.
* `login (username: String, password: String): (accessToken: String, refreshToken: String)`
  * **requires**: The provided username and password must match an existing user account.
  * **effects**: Creates a new session and returns a new pair of access and refresh tokens for the authenticated user.
* `refreshAccessToken (refreshToken: String): (accessToken: String)`
  * **requires**: A valid and non-expired refresh token must be provided.
  * **effects**: Generates and returns a new short-lived access token. Expired refresh tokens are automatically cleaned up.
* `logout (refreshToken: String)`
  * **requires**: A valid refresh token must be provided.
  * **effects**: Invalidates the user's current refresh token, ending their session.
* `changePassword (accessToken: String, oldPassword: String, newPassword: String)`
  * **requires**: A valid access token must be provided. The old password must match the user's current password.
  * **effects**: Updates the user's stored password hash to the new password.
* `deleteAccount (accessToken: String, password: String)`
  * **requires**: A valid access token must be provided. The provided password matches the user's current password.
  * **effects**: Permanently removes the user's account and all associated sessions.

**notes**:

* Sessions are stored separately from users to support multiple concurrent sessions per user and proper token management.
* Access tokens are not stored in state as they are stateless JWTs validated by signature. Only refresh tokens are stored for revocation purposes.
* Access tokens are short-lived (15 minutes) and can be refreshed using the `refreshAccessToken` action without requiring re-authentication.
* Refresh tokens are long-lived (7 days) and stored in the database, allowing for immediate revocation.
* Email addresses are normalized (trimmed and lowercased) during registration to prevent duplicate accounts with different casing.
* Email is required for account recovery and notifications, though the notification delivery itself is handled by the Notifications concept.
